<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout & Diet Tracker</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">Workout & Diet Tracker</h1>
                <p class="text-muted mb-0">Track your progress day by day</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary btn-sm me-2" onclick="loadData()">
                    &#8635; Refresh
                </button>
                <button class="btn btn-success btn-sm me-2" onclick="exportToCSV()">
                    &#8681; Export CSV
                </button>
                <button class="btn btn-warning btn-sm" onclick="clearHistory()">
                    &#128465; Clear History
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="alert alert-info" role="alert">
            Loading data from Excel files...
        </div>

        <!-- Error Message -->
        <div id="error" class="alert alert-danger d-none" role="alert"></div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="workout-tab" data-bs-toggle="tab" data-bs-target="#workout" type="button" role="tab">
                    Workout
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="diet-tab" data-bs-toggle="tab" data-bs-target="#diet" type="button" role="tab">
                    Diet
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                    History
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myTabContent">
            <!-- Workout Tab -->
            <div class="tab-pane fade show active" id="workout" role="tabpanel">
                <div class="mb-3">
                    <h5>Today: <span id="currentDate" class="badge bg-primary"></span></h5>
                </div>

                <!-- Day Selection -->
                <div id="daySelector" class="mb-4">
                    <h5 class="mb-3">Which day are you doing today?</h5>
                    <div class="d-grid gap-2" id="dayButtons"></div>
                </div>

                <!-- Selected Day Display -->
                <div id="selectedDay" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <span class="badge bg-success" id="selectedDayName"></span>
                        </h5>
                        <button class="btn btn-secondary btn-sm" onclick="changeDaySelection()">
                            Change Day
                        </button>
                    </div>
                    <div id="workoutTable" class="table-responsive"></div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="saveWorkoutSession()">
                            Save Session
                        </button>
                    </div>
                </div>
            </div>

            <!-- Diet Tab -->
            <div class="tab-pane fade" id="diet" role="tabpanel">
                <div class="mb-3">
                    <h5>Today: <span id="currentDateDiet" class="badge bg-primary"></span></h5>
                </div>
                <div id="dietTable" class="table-responsive"></div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="mb-3">
                    <p class="text-muted">View all your completed workouts and diet entries</p>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" onclick="filterHistory('all')">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterHistory('workout')">Workouts</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="filterHistory('diet')">Diet</button>
                    </div>
                </div>
                <div id="historyTable" class="table-responsive"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let workoutData = {};  // { 'Day 1 - Push': [...exercises], 'Day 2 - Legs': [...] }
        let dietData = {};     // { 'Lunch': [...options], 'Dinner': [...] }
        let completionLog = [];
        let selectedWorkoutDay = null;
        let currentHistoryFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCompletionLog();
            displayCurrentDate();
            loadData();
        });

        // Display current date
        function displayCurrentDate() {
            const today = new Date().toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('currentDate').textContent = today;
            document.getElementById('currentDateDiet').textContent = today;
        }

        // Load data from Excel files
        async function loadData() {
            try {
                document.getElementById('loading').classList.remove('d-none');
                document.getElementById('error').classList.add('d-none');

                // Fetch both Excel files
                const [workoutResponse, dietResponse] = await Promise.all([
                    fetch('workout.xlsx'),
                    fetch('diet.xlsx')
                ]);

                if (!workoutResponse.ok || !dietResponse.ok) {
                    throw new Error('Failed to fetch Excel files. Make sure workout.xlsx and diet.xlsx are in the same directory.');
                }

                // Convert to array buffers
                const [workoutBuffer, dietBuffer] = await Promise.all([
                    workoutResponse.arrayBuffer(),
                    dietResponse.arrayBuffer()
                ]);

                // Parse Excel files
                const workoutWorkbook = XLSX.read(workoutBuffer);
                const dietWorkbook = XLSX.read(dietBuffer);

                // Get first sheet from each workbook
                const workoutSheet = workoutWorkbook.Sheets[workoutWorkbook.SheetNames[0]];
                const dietSheet = dietWorkbook.Sheets[dietWorkbook.SheetNames[0]];

                // Convert to JSON (with headers)
                const workoutRows = XLSX.utils.sheet_to_json(workoutSheet);
                const dietRows = XLSX.utils.sheet_to_json(dietSheet);

                // Parse workout data by days
                parseWorkoutData(workoutRows);

                // Parse diet data by meals
                parseDietData(dietRows);

                // Render UI
                renderDaySelector();
                renderDietTable();
                renderHistoryTable();

                document.getElementById('loading').classList.add('d-none');
            } catch (error) {
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').classList.remove('d-none');
                console.error('Error loading data:', error);
            }
        }

        // Parse workout data organized by days
        function parseWorkoutData(rows) {
            workoutData = {};
            let currentDay = null;

            rows.forEach((row, index) => {
                if (row.Day) {
                    currentDay = row.Day;
                    // Only create new array if this day doesn't exist yet
                    if (!workoutData[currentDay]) {
                        workoutData[currentDay] = [];
                    }
                }

                if (currentDay && row.Exercise) {
                    workoutData[currentDay].push({
                        exercise: row.Exercise,
                        sets: row.Sets,
                        reps: row.Reps,
                        weightUsed: row['Weight Used'],
                        rpe: row.RPE,
                        notes: row.Notes
                    });
                }
            });
        }

        // Parse diet data organized by meals
        function parseDietData(rows) {
            dietData = {};

            rows.forEach(row => {
                if (row.Meal && row.Option) {
                    if (!dietData[row.Meal]) {
                        dietData[row.Meal] = [];
                    }
                    dietData[row.Meal].push({
                        option: row.Option,
                        protein: row['Protein (g)'],
                        notes: row.Notes
                    });
                }
            });
        }

        // Render day selector buttons
        function renderDaySelector() {
            const days = Object.keys(workoutData);
            let html = '';

            days.forEach(day => {
                html += `<button class="btn btn-lg btn-outline-primary" onclick="selectDay('${escapeHtml(day)}')">${day}</button>`;
            });

            document.getElementById('dayButtons').innerHTML = html;
        }

        // Select a workout day
        function selectDay(day) {
            selectedWorkoutDay = day;
            document.getElementById('daySelector').classList.add('d-none');
            document.getElementById('selectedDay').classList.remove('d-none');
            document.getElementById('selectedDayName').textContent = day;
            renderWorkoutTable();
        }

        // Change day selection
        function changeDaySelection() {
            selectedWorkoutDay = null;
            document.getElementById('daySelector').classList.remove('d-none');
            document.getElementById('selectedDay').classList.add('d-none');
        }

        // Render workout table for selected day
        function renderWorkoutTable() {
            if (!selectedWorkoutDay || !workoutData[selectedWorkoutDay]) {
                return;
            }

            const exercises = workoutData[selectedWorkoutDay];
            let html = '<table class="table table-striped table-hover"><thead class="table-dark"><tr>';
            html += '<th>Exercise</th><th>Sets</th><th>Reps</th><th>Weight</th><th>RPE</th><th>Done</th><th>Notes</th></tr></thead><tbody>';

            exercises.forEach((exercise, index) => {
                html += `<tr>
                    <td><strong>${exercise.exercise}</strong></td>
                    <td>${exercise.sets || '-'}</td>
                    <td>${exercise.reps || '-'}</td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               id="weight-${index}"
                               placeholder="${exercise.weightUsed || 'Enter'}"
                               style="width: 80px;">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm"
                               id="rpe-${index}"
                               placeholder="${exercise.rpe || 'RPE'}"
                               min="1" max="10"
                               style="width: 70px;">
                    </td>
                    <td>
                        <input type="checkbox" class="form-check-input" id="done-${index}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               id="note-${index}"
                               placeholder="Add note...">
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('workoutTable').innerHTML = html;
        }

        // Save workout session
        function saveWorkoutSession() {
            if (!selectedWorkoutDay) return;

            const exercises = workoutData[selectedWorkoutDay];
            let completed = 0;

            exercises.forEach((exercise, index) => {
                const isDone = document.getElementById(`done-${index}`).checked;

                if (isDone) {
                    const weight = document.getElementById(`weight-${index}`).value;
                    const rpe = document.getElementById(`rpe-${index}`).value;
                    const note = document.getElementById(`note-${index}`).value;

                    const entry = {
                        date: new Date().toISOString(),
                        type: 'workout',
                        day: selectedWorkoutDay,
                        item: exercise.exercise,
                        sets: exercise.sets,
                        reps: exercise.reps,
                        weight: weight,
                        rpe: rpe,
                        status: 'completed',
                        notes: note,
                        timestamp: Date.now()
                    };

                    completionLog.push(entry);
                    completed++;
                }
            });

            if (completed > 0) {
                saveCompletionLog();
                renderHistoryTable();
                alert(`Session saved! ${completed} exercise(s) logged.`);
                changeDaySelection(); // Reset to day selector
            } else {
                alert('Please mark at least one exercise as done before saving.');
            }
        }

        // Render diet table
        function renderDietTable() {
            if (Object.keys(dietData).length === 0) {
                document.getElementById('dietTable').innerHTML = '<p class="text-muted">No diet data found.</p>';
                return;
            }

            let html = '';

            Object.keys(dietData).forEach(meal => {
                html += `<div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">${meal}</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Option</th>
                                    <th>Protein</th>
                                    <th>Notes</th>
                                    <th>Done</th>
                                    <th>My Notes</th>
                                </tr>
                            </thead>
                            <tbody>`;

                dietData[meal].forEach((option, index) => {
                    const uniqueId = `${meal.replace(/\s+/g, '')}-${index}`;
                    html += `<tr>
                        <td><strong>${option.option}</strong></td>
                        <td><span class="badge bg-info">${option.protein || '-'}g</span></td>
                        <td><small class="text-muted">${option.notes || '-'}</small></td>
                        <td>
                            <input type="checkbox" class="form-check-input"
                                   onchange="markDietComplete('${meal}', '${escapeHtml(option.option)}', '${option.protein}', this, '${uniqueId}')">
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   id="diet-note-${uniqueId}"
                                   placeholder="Add note...">
                        </td>
                    </tr>`;
                });

                html += `</tbody></table></div></div>`;
            });

            document.getElementById('dietTable').innerHTML = html;
        }

        // Mark diet item as complete
        function markDietComplete(meal, option, protein, checkbox, uniqueId) {
            if (checkbox.checked) {
                const note = document.getElementById(`diet-note-${uniqueId}`).value;

                const entry = {
                    date: new Date().toISOString(),
                    type: 'diet',
                    meal: meal,
                    item: option,
                    protein: protein,
                    status: 'completed',
                    notes: note,
                    timestamp: Date.now()
                };

                completionLog.push(entry);
                saveCompletionLog();
                renderHistoryTable();

                // Visual feedback
                checkbox.parentElement.parentElement.classList.add('table-success');
                setTimeout(() => {
                    checkbox.parentElement.parentElement.classList.remove('table-success');
                    checkbox.checked = false;
                }, 1500);
            }
        }

        // Filter history
        function filterHistory(filter) {
            currentHistoryFilter = filter;

            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderHistoryTable();
        }

        // Render history table
        function renderHistoryTable() {
            let filteredLog = completionLog;

            if (currentHistoryFilter !== 'all') {
                filteredLog = completionLog.filter(entry => entry.type === currentHistoryFilter);
            }

            if (filteredLog.length === 0) {
                document.getElementById('historyTable').innerHTML = '<p class="text-muted">No history yet. Start tracking!</p>';
                return;
            }

            // Sort by date (newest first)
            const sortedLog = [...filteredLog].sort((a, b) => b.timestamp - a.timestamp);

            let html = '<table class="table table-striped table-sm"><thead class="table-dark"><tr>';
            html += '<th>Date</th><th>Type</th><th>Day/Meal</th><th>Item</th><th>Details</th><th>Notes</th></tr></thead><tbody>';

            sortedLog.forEach(entry => {
                const date = new Date(entry.date).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let details = '';
                if (entry.type === 'workout') {
                    details = `${entry.sets || '-'} x ${entry.reps || '-'}`;
                    if (entry.weight) details += ` @ ${entry.weight}`;
                    if (entry.rpe) details += ` RPE${entry.rpe}`;
                } else if (entry.type === 'diet') {
                    details = entry.protein ? `${entry.protein}g protein` : '-';
                }

                html += `<tr>
                    <td><small>${date}</small></td>
                    <td><span class="badge bg-${entry.type === 'workout' ? 'primary' : 'success'}">${entry.type}</span></td>
                    <td><small>${entry.day || entry.meal || '-'}</small></td>
                    <td><strong>${entry.item}</strong></td>
                    <td><small>${details}</small></td>
                    <td><small>${entry.notes || '-'}</small></td>
                </tr>`;
            });

            html += '</tbody></table>';
            document.getElementById('historyTable').innerHTML = html;
        }

        // Save completion log to localStorage
        function saveCompletionLog() {
            localStorage.setItem('completionLog', JSON.stringify(completionLog));
        }

        // Load completion log from localStorage
        function loadCompletionLog() {
            const saved = localStorage.getItem('completionLog');
            if (saved) {
                completionLog = JSON.parse(saved);
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (completionLog.length === 0) {
                alert('No data to export. Complete some workouts first!');
                return;
            }

            // CSV headers
            let csv = 'Date,Type,Day/Meal,Exercise/Food,Sets,Reps,Weight,RPE,Protein,Status,Notes\n';

            // Add data rows
            completionLog.forEach(entry => {
                const date = new Date(entry.date).toLocaleString('en-US');
                const dayMeal = entry.day || entry.meal || '';
                const sets = entry.sets || '';
                const reps = entry.reps || '';
                const weight = entry.weight || '';
                const rpe = entry.rpe || '';
                const protein = entry.protein || '';

                csv += `"${date}","${entry.type}","${dayMeal}","${entry.item}","${sets}","${reps}","${weight}","${rpe}","${protein}","${entry.status}","${entry.notes || ''}"\n`;
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout-diet-log-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                completionLog = [];
                saveCompletionLog();
                renderHistoryTable();
                alert('History cleared successfully!');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }
    </script>
</body>
</html>
