<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout & Diet Tracker</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Header -->
        <div class="row mb-3">
            <div class="col">
                <h1 class="h3">Workout & Diet Tracker</h1>
                <p class="text-muted mb-0">Track your progress day by day</p>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary btn-sm me-2" data-action="refresh">
                    &#8635; Refresh
                </button>
                <button class="btn btn-success btn-sm me-2" data-action="export-csv">
                    &#8681; Export CSV
                </button>
                <button class="btn btn-warning btn-sm" data-action="clear-history">
                    &#128465; Clear History
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="alert alert-info" role="alert">
            Loading data from Excel files...
        </div>

        <!-- Error Message -->
        <div id="error" class="alert alert-danger d-none" role="alert"></div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="workout-tab" data-bs-toggle="tab" data-bs-target="#workout" type="button" role="tab">
                    Workout
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="diet-tab" data-bs-toggle="tab" data-bs-target="#diet" type="button" role="tab">
                    Diet
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
                    History
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myTabContent">
            <!-- Workout Tab -->
            <div class="tab-pane fade show active" id="workout" role="tabpanel">
                <div class="mb-3">
                    <h5>Today: <span id="currentDate" class="badge bg-primary"></span></h5>
                </div>

                <!-- Week Selection -->
                <div id="weekSelector" class="mb-4">
                    <h5 class="mb-3">Select Your Week</h5>
                    <div class="d-grid gap-2" id="weekButtons"></div>
                </div>

                <!-- Day Selection -->
                <div id="daySelector" class="mb-4 d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <span class="badge bg-info" id="selectedWeekName"></span>
                            <span class="ms-2">Select Your Day</span>
                        </h5>
                        <button class="btn btn-secondary btn-sm" data-action="change-week">
                            Change Week
                        </button>
                    </div>
                    <div class="d-grid gap-2" id="dayButtons"></div>
                </div>

                <!-- Selected Day Display -->
                <div id="selectedDay" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <span class="badge bg-info" id="selectedWeekDisplay"></span>
                            <span class="badge bg-success ms-2" id="selectedDayName"></span>
                        </h5>
                        <button class="btn btn-secondary btn-sm" data-action="change-day">
                            Change Day
                        </button>
                    </div>
                    <div id="workoutTable" class="table-responsive"></div>
                    <div class="mt-3">
                        <button class="btn btn-primary" data-action="save-session">
                            Save Session
                        </button>
                    </div>
                </div>
            </div>

            <!-- Diet Tab -->
            <div class="tab-pane fade" id="diet" role="tabpanel">
                <div class="mb-3">
                    <h5>Today: <span id="currentDateDiet" class="badge bg-primary"></span></h5>
                </div>
                <div id="dietTable" class="table-responsive"></div>
            </div>

            <!-- History Tab -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="mb-3">
                    <p class="text-muted">View all your completed workouts and diet entries</p>
                    <div class="btn-group" role="group" id="historyFilterButtons">
                        <button type="button" class="btn btn-sm btn-outline-primary active" data-filter="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-filter="workout">Workouts</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-filter="diet">Diet</button>
                    </div>
                </div>
                <div id="historyTable" class="table-responsive"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let workoutData = {};  // { 'Week 1': { 'Day 1': { focus: 'Upper Push', exercises: [...] } } }
        let dietData = {};     // { 'Lunch': [...options], 'Dinner': [...] }
        let completionLog = [];
        let selectedWeek = null;
        let selectedWorkoutDay = null;
        let currentHistoryFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCompletionLog();
            displayCurrentDate();
            loadData();
            setupEventListeners();
        });

        // Setup all event listeners using event delegation
        function setupEventListeners() {
            // Main action buttons
            document.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                
                switch(action) {
                    case 'refresh':
                        loadData();
                        break;
                    case 'export-csv':
                        exportToCSV();
                        break;
                    case 'clear-history':
                        clearHistory();
                        break;
                    case 'change-week':
                        changeWeekSelection();
                        break;
                    case 'change-day':
                        changeDaySelection();
                        break;
                    case 'save-session':
                        saveWorkoutSession();
                        break;
                }

                // Week selection
                const week = e.target.closest('[data-week]')?.dataset.week;
                if (week) {
                    selectWeek(week);
                }

                // Day selection
                const day = e.target.closest('[data-day]')?.dataset.day;
                if (day) {
                    selectDay(day);
                }

                // History filter
                const filter = e.target.closest('[data-filter]')?.dataset.filter;
                if (filter) {
                    filterHistory(filter, e.target);
                }
            });

            // Diet checkbox changes
            document.addEventListener('change', (e) => {
                if (e.target.matches('[data-diet-checkbox]')) {
                    const { meal, option, protein, uniqueId } = e.target.dataset;
                    markDietComplete(meal, option, protein, e.target, uniqueId);
                }
            });
        }

        // Display current date
        function displayCurrentDate() {
            const today = new Date().toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('currentDate').textContent = today;
            document.getElementById('currentDateDiet').textContent = today;
        }

        // Load data from Excel files
        async function loadData() {
            try {
                document.getElementById('loading').classList.remove('d-none');
                document.getElementById('error').classList.add('d-none');

                // Fetch both Excel files
                const [workoutResponse, dietResponse] = await Promise.all([
                    fetch('Prudhvi_4Week_Progressive_Workout.xlsx'),
                    fetch('diet.xlsx')
                ]);

                if (!workoutResponse.ok || !dietResponse.ok) {
                    throw new Error('Failed to fetch Excel files. Make sure Prudhvi_4Week_Progressive_Workout.xlsx and diet.xlsx are in the same directory.');
                }

                // Convert to array buffers
                const [workoutBuffer, dietBuffer] = await Promise.all([
                    workoutResponse.arrayBuffer(),
                    dietResponse.arrayBuffer()
                ]);

                // Parse Excel files
                const workoutWorkbook = XLSX.read(workoutBuffer);
                const dietWorkbook = XLSX.read(dietBuffer);

                // Get first sheet from each workbook
                const workoutSheet = workoutWorkbook.Sheets[workoutWorkbook.SheetNames[0]];
                const dietSheet = dietWorkbook.Sheets[dietWorkbook.SheetNames[0]];

                // Convert to JSON (with headers)
                const workoutRows = XLSX.utils.sheet_to_json(workoutSheet);
                const dietRows = XLSX.utils.sheet_to_json(dietSheet);

                // Parse workout data by weeks and days
                parseWorkoutData(workoutRows);

                // Parse diet data by meals
                parseDietData(dietRows);

                // Render UI
                renderWeekSelector();
                renderDietTable();
                renderHistoryTable();

                document.getElementById('loading').classList.add('d-none');
            } catch (error) {
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').classList.remove('d-none');
                console.error('Error loading data:', error);
            }
        }

        // Parse workout data organized by weeks and days
        function parseWorkoutData(rows) {
            workoutData = {};

            rows.forEach((row, index) => {
                if (row.Week && row.Day && row.Exercise) {
                    const week = row.Week;
                    const day = row.Day;
                    const focus = row['Workout Focus'];

                    // Initialize week if not exists
                    if (!workoutData[week]) {
                        workoutData[week] = {};
                    }

                    // Initialize day if not exists
                    if (!workoutData[week][day]) {
                        workoutData[week][day] = {
                            focus: focus,
                            exercises: []
                        };
                    }

                    // Add exercise
                    workoutData[week][day].exercises.push({
                        exercise: row.Exercise,
                        sets: row.Sets,
                        reps: row.Reps,
                        progression: row['Progression Rule'],
                        notes: row.Notes
                    });
                }
            });
        }

        // Parse diet data organized by meals
        function parseDietData(rows) {
            dietData = {};

            rows.forEach(row => {
                if (row.Meal && row.Option) {
                    if (!dietData[row.Meal]) {
                        dietData[row.Meal] = [];
                    }
                    dietData[row.Meal].push({
                        option: row.Option,
                        protein: row['Protein (g)'],
                        notes: row.Notes
                    });
                }
            });
        }

        // Render week selector buttons
        function renderWeekSelector() {
            const weeks = Object.keys(workoutData).sort();
            const html = weeks.map(week => 
                `<button class="btn btn-lg btn-outline-primary" data-week="${escapeHtml(week)}">${week}</button>`
            ).join('');

            document.getElementById('weekButtons').innerHTML = html;
        }

        // Select a week
        function selectWeek(week) {
            selectedWeek = week;
            document.getElementById('weekSelector').classList.add('d-none');
            document.getElementById('daySelector').classList.remove('d-none');
            document.getElementById('selectedWeekName').textContent = week;
            renderDaySelector();
        }

        // Change week selection
        function changeWeekSelection() {
            selectedWeek = null;
            selectedWorkoutDay = null;
            document.getElementById('weekSelector').classList.remove('d-none');
            document.getElementById('daySelector').classList.add('d-none');
            document.getElementById('selectedDay').classList.add('d-none');
        }

        // Render day selector buttons for selected week
        function renderDaySelector() {
            if (!selectedWeek || !workoutData[selectedWeek]) {
                return;
            }

            const days = Object.keys(workoutData[selectedWeek]).sort();
            const html = days.map(day => {
                return `<button class="btn btn-lg btn-outline-success" data-day="${escapeHtml(day)}">
                    <strong>${day}</strong>
                </button>`;
            }).join('');

            document.getElementById('dayButtons').innerHTML = html;
        }

        // Select a workout day
        function selectDay(day) {
            selectedWorkoutDay = day;
            document.getElementById('daySelector').classList.add('d-none');
            document.getElementById('selectedDay').classList.remove('d-none');
            document.getElementById('selectedWeekDisplay').textContent = selectedWeek;
            document.getElementById('selectedDayName').textContent = day;
            renderWorkoutTable();
        }

        // Change day selection
        function changeDaySelection() {
            selectedWorkoutDay = null;
            document.getElementById('daySelector').classList.remove('d-none');
            document.getElementById('selectedDay').classList.add('d-none');
        }

        // Render workout table for selected day
        function renderWorkoutTable() {
            if (!selectedWeek || !selectedWorkoutDay || !workoutData[selectedWeek] || !workoutData[selectedWeek][selectedWorkoutDay]) {
                return;
            }

            const dayData = workoutData[selectedWeek][selectedWorkoutDay];
            const exercises = dayData.exercises;
            
            const tableRows = exercises.map((exercise, index) => {
                const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(exercise.exercise + ' exercise')}`;
                
                return `<tr>
                    <td>
                        <strong>${exercise.exercise}</strong>
                        <a href="${googleSearchUrl}" target="_blank" rel="noopener noreferrer" 
                           class="ms-2 text-decoration-none" 
                           title="Search how to do this exercise">
                            üîç
                        </a>
                    </td>
                    <td>${exercise.sets || '-'}</td>
                    <td>${exercise.reps || '-'}</td>
                    <td><span class="badge bg-warning text-dark">${exercise.progression || '-'}</span></td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               id="weight-${index}"
                               placeholder="Enter"
                               style="width: 80px;">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm"
                               id="rpe-${index}"
                               placeholder="RPE"
                               min="1" max="10"
                               style="width: 70px;">
                    </td>
                    <td>
                        <input type="checkbox" class="form-check-input" id="done-${index}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm"
                               id="note-${index}"
                               placeholder="${exercise.notes || 'Add note...'}">
                    </td>
                </tr>`;
            }).join('');

            const html = `<table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Exercise</th><th>Sets</th><th>Reps</th><th>Progression</th>
                        <th>Weight</th><th>RPE</th><th>Done</th><th>Notes</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>`;
            
            document.getElementById('workoutTable').innerHTML = html;
        }

        // Save workout session
        function saveWorkoutSession() {
            if (!selectedWeek || !selectedWorkoutDay) return;

            const dayData = workoutData[selectedWeek][selectedWorkoutDay];
            const exercises = dayData.exercises;
            let completed = 0;

            exercises.forEach((exercise, index) => {
                const isDone = document.getElementById(`done-${index}`).checked;

                if (isDone) {
                    const weight = document.getElementById(`weight-${index}`).value;
                    const rpe = document.getElementById(`rpe-${index}`).value;
                    const note = document.getElementById(`note-${index}`).value;

                    const entry = {
                        date: new Date().toISOString(),
                        type: 'workout',
                        week: selectedWeek,
                        day: selectedWorkoutDay,
                        focus: dayData.focus,
                        item: exercise.exercise,
                        sets: exercise.sets,
                        reps: exercise.reps,
                        progression: exercise.progression,
                        weight: weight,
                        rpe: rpe,
                        status: 'completed',
                        notes: note,
                        timestamp: Date.now()
                    };

                    completionLog.push(entry);
                    completed++;
                }
            });

            if (completed > 0) {
                saveCompletionLog();
                renderHistoryTable();
                alert(`Session saved! ${completed} exercise(s) logged.`);
                changeDaySelection(); // Reset to day selector
            } else {
                alert('Please mark at least one exercise as done before saving.');
            }
        }

        // Render diet table
        function renderDietTable() {
            if (Object.keys(dietData).length === 0) {
                document.getElementById('dietTable').innerHTML = '<p class="text-muted">No diet data found.</p>';
                return;
            }

            const html = Object.keys(dietData).map(meal => {
                const rows = dietData[meal].map((option, index) => {
                    const uniqueId = `${meal.replace(/\s+/g, '')}-${index}`;
                    return `<tr>
                        <td><strong>${option.option}</strong></td>
                        <td><span class="badge bg-info">${option.protein || '-'}g</span></td>
                        <td><small class="text-muted">${option.notes || '-'}</small></td>
                        <td>
                            <input type="checkbox" class="form-check-input"
                                   data-diet-checkbox
                                   data-meal="${meal}"
                                   data-option="${escapeHtml(option.option)}"
                                   data-protein="${option.protein}"
                                   data-unique-id="${uniqueId}">
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm"
                                   id="diet-note-${uniqueId}"
                                   placeholder="Add note...">
                        </td>
                    </tr>`;
                }).join('');

                return `<div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">${meal}</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Option</th>
                                    <th>Protein</th>
                                    <th>Notes</th>
                                    <th>Done</th>
                                    <th>My Notes</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                </div>`;
            }).join('');

            document.getElementById('dietTable').innerHTML = html;
        }

        // Mark diet item as complete
        function markDietComplete(meal, option, protein, checkbox, uniqueId) {
            if (checkbox.checked) {
                const note = document.getElementById(`diet-note-${uniqueId}`).value;

                const entry = {
                    date: new Date().toISOString(),
                    type: 'diet',
                    meal: meal,
                    item: option,
                    protein: protein,
                    status: 'completed',
                    notes: note,
                    timestamp: Date.now()
                };

                completionLog.push(entry);
                saveCompletionLog();
                renderHistoryTable();

                // Visual feedback
                checkbox.parentElement.parentElement.classList.add('table-success');
                setTimeout(() => {
                    checkbox.parentElement.parentElement.classList.remove('table-success');
                    checkbox.checked = false;
                }, 1500);
            }
        }

        // Filter history
        function filterHistory(filter, targetButton) {
            currentHistoryFilter = filter;

            // Update button states
            document.querySelectorAll('#historyFilterButtons .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            targetButton.classList.add('active');

            renderHistoryTable();
        }

        // Render history table
        function renderHistoryTable() {
            const filteredLog = currentHistoryFilter === 'all' 
                ? completionLog 
                : completionLog.filter(entry => entry.type === currentHistoryFilter);

            if (filteredLog.length === 0) {
                document.getElementById('historyTable').innerHTML = '<p class="text-muted">No history yet. Start tracking!</p>';
                return;
            }

            // Sort by date (newest first)
            const sortedLog = [...filteredLog].sort((a, b) => b.timestamp - a.timestamp);

            const tableRows = sortedLog.map(entry => {
                const date = new Date(entry.date).toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let details = '';
                if (entry.type === 'workout') {
                    details = `${entry.sets || '-'} x ${entry.reps || '-'}`;
                    if (entry.weight) details += ` @ ${entry.weight}`;
                    if (entry.rpe) details += ` RPE${entry.rpe}`;
                    if (entry.progression) details += ` | ${entry.progression}`;
                } else if (entry.type === 'diet') {
                    details = entry.protein ? `${entry.protein}g protein` : '-';
                }

                const weekDisplay = entry.week || '-';
                const dayMealDisplay = entry.type === 'workout' 
                    ? `${entry.day || '-'}${entry.focus ? ' (' + entry.focus + ')' : ''}`
                    : entry.meal || '-';

                return `<tr>
                    <td><small>${date}</small></td>
                    <td><span class="badge bg-${entry.type === 'workout' ? 'primary' : 'success'}">${entry.type}</span></td>
                    <td><small>${weekDisplay}</small></td>
                    <td><small>${dayMealDisplay}</small></td>
                    <td><strong>${entry.item}</strong></td>
                    <td><small>${details}</small></td>
                    <td><small>${entry.notes || '-'}</small></td>
                </tr>`;
            }).join('');

            const html = `<table class="table table-striped table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th><th>Type</th><th>Week</th><th>Day/Meal</th>
                        <th>Item</th><th>Details</th><th>Notes</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>`;
            
            document.getElementById('historyTable').innerHTML = html;
        }

        // Save completion log to localStorage
        function saveCompletionLog() {
            localStorage.setItem('completionLog', JSON.stringify(completionLog));
        }

        // Load completion log from localStorage
        function loadCompletionLog() {
            const saved = localStorage.getItem('completionLog');
            if (saved) {
                completionLog = JSON.parse(saved);
            }
        }

        // Export to CSV
        function exportToCSV() {
            if (completionLog.length === 0) {
                alert('No data to export. Complete some workouts first!');
                return;
            }

            // CSV headers
            let csv = 'Date,Type,Week,Day/Meal,Focus,Exercise/Food,Sets,Reps,Progression,Weight,RPE,Protein,Status,Notes\n';

            // Add data rows
            completionLog.forEach(entry => {
                const date = new Date(entry.date).toLocaleString('en-US');
                const week = entry.week || '';
                const dayMeal = entry.day || entry.meal || '';
                const focus = entry.focus || '';
                const sets = entry.sets || '';
                const reps = entry.reps || '';
                const progression = entry.progression || '';
                const weight = entry.weight || '';
                const rpe = entry.rpe || '';
                const protein = entry.protein || '';

                csv += `"${date}","${entry.type}","${week}","${dayMeal}","${focus}","${entry.item}","${sets}","${reps}","${progression}","${weight}","${rpe}","${protein}","${entry.status}","${entry.notes || ''}"\n`;
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout-diet-log-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Clear history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all history? This cannot be undone.')) {
                completionLog = [];
                saveCompletionLog();
                renderHistoryTable();
                alert('History cleared successfully!');
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }
    </script>
</body>
</html>
